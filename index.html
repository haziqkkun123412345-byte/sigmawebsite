<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>temu discord ‚Äî made by haziq</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--accent:#9c27b0}
body{
  margin:0; font-family:Segoe UI,Arial,sans-serif;
  background: linear-gradient(135deg,#6a0dad,#000);
  color:white; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:18px;
}
h1{margin:6px 0 14px; text-shadow:0 0 8px rgba(0,0,0,.4)}
.topbar{display:flex;gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap}
.card{background:rgba(255,255,255,.06); padding:12px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.5)}
#roomsRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
select, input[type="text"], input[type="color"]{padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,.08); color:white}
button{background:var(--accent); color:white; padding:8px 10px; border:none; border-radius:8px; cursor:pointer; font-weight:600}
button:hover{opacity:.95}
#comments{width:100%; max-width:900px; margin-top:14px; background:rgba(255,255,255,.06); border-radius:10px; padding:12px; max-height:420px; overflow:auto; scroll-behavior: smooth;}
.comment{background:rgba(0,0,0,.35); padding:10px; border-radius:8px; margin-bottom:8px; position:relative; display:flex; flex-direction:column}
.commentTop{display:flex; align-items:center; gap:8px}
.username{font-weight:700}
.meta{font-size:12px; color:#ddd; margin-left:8px}
.deleteBtn{position:absolute; right:10px; top:10px; background:transparent; border:none; color:#ff7675; cursor:pointer}
.reactionsBtn{position:absolute; top:10px; right:110px; background:transparent; border:none; color:#fff; cursor:pointer}
.small{font-size:13px; color:#ddd}
.emojiInput{width:40px; padding:2px 6px; border-radius:6px; border:none; background:rgba(255,255,255,.1); color:#fff; text-align:center}
.overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:999}
.modal{width:92%; max-width:420px; background:rgba(255,255,255,0.06); padding:12px; border-radius:10px}
.list-item{display:flex; justify-content:space-between; align-items:center; padding:8px 6px; border-bottom:1px solid rgba(255,255,255,0.03)}
@media (max-width:520px){ .topbar{flex-direction:column; align-items:stretch} .card{width:100%} #comments{max-height:300px} }
</style>
</head>
<body>

<h1>üí¨ temu discord ‚Äî made by haziq</h1>

<div class="topbar">
  <!-- Room selection -->
  <div class="card" id="roomCard">
    <div id="roomsRow">
      <label class="small" for="roomsSelect">Room:</label>
      <select id="roomsSelect">
        <option value="">‚Äî Select a room ‚Äî</option>
      </select>
      <input id="newRoomInput" type="text" placeholder="New room name (e.g. Chat1)">
      <button id="createRoomBtn">Create room</button>
    </div>
    <div class="small" style="margin-top:8px">Active room: <span id="activeRoomName">None</span></div>
  </div>

  <!-- Username -->
  <div class="card" id="userCard">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <div class="small">Name:</div>
      <input id="usernameInput" type="text" placeholder="Your name">
      <button id="saveUsernameBtn">Save</button>
      <button id="changeUsernameBtn">Change</button>
    </div>
    <div class="small" style="margin-top:8px">You can change your name anytime. Saved locally.</div>
  </div>

  <!-- Admin/Online/Ban/Rules buttons -->
  <div class="card" id="adminCard" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
    <button id="onlineBtn">üë• Online Players</button>
    <button id="adminBtn">‚öôÔ∏è Admin Panel</button>
    <button id="banlandBtn">üö´ Banland</button>
    <button id="rulesBtn">üìú Rules</button>
  </div>
</div>

<!-- Message input -->
<div class="card" style="width:100%; max-width:900px; margin-bottom:8px">
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
    <input id="messageInput" type="text" placeholder="Type a message..." style="flex:1">
    <button id="sendBtn">Send</button>
  </div>
  <div class="small" style="margin-top:8px">Selected room: <strong id="selectedRoomDisplay">‚Äî</strong></div>
</div>

<!-- Comments -->
<div id="comments" class="card"></div>

<!-- Overlays -->
<div id="onlineOverlay" class="overlay"><div class="modal">
  <h3>üë• Online Players</h3>
  <div id="onlineList"></div>
  <div style="text-align:right; margin-top:8px"><button id="closeOnline">Close</button></div>
</div></div>

<div id="adminOverlay" class="overlay"><div class="modal">
  <h3>‚öôÔ∏è Admin Panel</h3>
  <div id="adminInfo" style="margin-bottom:8px"></div>
  <div style="display:flex; gap:8px; flex-wrap:wrap">
    <button id="clearMessagesBtn">Clear all messages (room)</button>
    <button id="claimRoomBtn">Claim room as admin</button>
  </div>
  <div style="text-align:right; margin-top:8px"><button id="closeAdmin">Close</button></div>
</div></div>

<div id="banOverlay" class="overlay"><div class="modal">
  <h3>üö´ Banland</h3>
  <div>
    <input id="banUserInput" placeholder="User ID (e.g. ab12cd34)">
    <button id="banUserBtn">Ban user</button>
  </div>
  <div style="margin-top:8px"><strong>Banned in this room:</strong></div>
  <div id="bannedList" style="margin-top:8px"></div>
  <div style="text-align:right; margin-top:8px"><button id="closeBan">Close</button></div>
</div></div>

<div id="rulesOverlay" class="overlay"><div class="modal">
  <h3>üìú Rules</h3>
  <ol style="text-align:left">
    <li>No hate speech / slurs.</li>
    <li>No spam or advertising.</li>
    <li>Respect other players.</li>
    <li>Admins can ban or remove messages.</li>
  </ol>
  <div style="text-align:right; margin-top:8px"><button id="closeRules">Close</button></div>
</div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, child, get, set } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

// Firebase config (your project)
const firebaseConfig = {
  apiKey: "AIzaSyDgORv7p_8He7kFKmFZ2oKJqSoOYeJoKKY",
  authDomain: "sigma-website-f2426.firebaseapp.com",
  databaseURL: "https://sigma-website-f2426-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sigma-website-f2426",
  storageBucket: "sigma-website-f2426.firebasestorage.app",
  messagingSenderId: "1030464935755",
  appId: "1:1030464935755:web:5784435e0cfe18ba30bace",
  measurementId: "G-1V1CJC9MHG"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Elements
const roomsSelect = document.getElementById('roomsSelect');
const createRoomBtn = document.getElementById('createRoomBtn');
const newRoomInput = document.getElementById('newRoomInput');
const activeRoomName = document.getElementById('activeRoomName');
const selectedRoomDisplay = document.getElementById('selectedRoomDisplay');

const usernameInput = document.getElementById('usernameInput');
const saveUsernameBtn = document.getElementById('saveUsernameBtn');
const changeUsernameBtn = document.getElementById('changeUsernameBtn');

const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const commentsDiv = document.getElementById('comments');

const onlineBtn = document.getElementById('onlineBtn');
const adminBtn = document.getElementById('adminBtn');
const banlandBtn = document.getElementById('banlandBtn');
const rulesBtn = document.getElementById('rulesBtn');

const onlineOverlay = document.getElementById('onlineOverlay');
const adminOverlay = document.getElementById('adminOverlay');
const banOverlay = document.getElementById('banOverlay');
const rulesOverlay = document.getElementById('rulesOverlay');

const closeOnline = document.getElementById('closeOnline');
const closeAdmin = document.getElementById('closeAdmin');
const closeBan = document.getElementById('closeBan');
const closeRules = document.getElementById('closeRules');

const onlineList = document.getElementById('onlineList');
const adminInfo = document.getElementById('adminInfo');
const clearMessagesBtn = document.getElementById('clearMessagesBtn');
const claimRoomBtn = document.getElementById('claimRoomBtn');

const banUserInput = document.getElementById('banUserInput');
const banUserBtn = document.getElementById('banUserBtn');
const bannedList = document.getElementById('bannedList');

// User local data
let username = localStorage.getItem('sigma_username') || '';
let userId = localStorage.getItem('sigma_userId');
let userColor = localStorage.getItem('sigma_userColor');
let lastRoom = localStorage.getItem('sigma_lastRoom');

if (!userId) { userId = Math.random().toString(36).slice(2,12); localStorage.setItem('sigma_userId', userId); }
if (!userColor) { userColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'); localStorage.setItem('sigma_userColor', userColor); }
if (username) { usernameInput.value = username; usernameInput.disabled = true; }

// Rooms
const roomsRef = ref(db, 'rooms');
let activeRoomId = null;
let currentListenerUnsub = null;

onValue(roomsRef, snap=>{
  const val = snap.val() || {};
  const prev = roomsSelect.value;
  roomsSelect.innerHTML = '';
  const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='‚Äî Select a room ‚Äî'; roomsSelect.appendChild(opt0);
  Object.keys(val).forEach(id=>{
    const o = document.createElement('option'); o.value=id; o.textContent=val[id].name; roomsSelect.appendChild(o);
  });
  if(lastRoom && val[lastRoom]) { roomsSelect.value = lastRoom; switchRoom(lastRoom); }
  else if(prev && val[prev]) { roomsSelect.value = prev; switchRoom(prev); }
});

// Create room (set createdBy)
createRoomBtn.onclick = async () => {
  const name = newRoomInput.value.trim();
  if(!name) return alert('Type a room name first');
  const snap = await get(roomsRef);
  const rooms = snap.val()||{};
  const exists = Object.values(rooms).some(r=>r.name && r.name.toLowerCase()===name.toLowerCase());
  if(exists) return alert('Room name already exists');
  const pushed = await push(roomsRef, { name, createdBy: userId, createdAt: Date.now() });
  newRoomInput.value='';
  // auto-select created room:
  roomsSelect.value = pushed.key;
  switchRoom(pushed.key);
};

// Switch room
roomsSelect.onchange = ()=> switchRoom(roomsSelect.value || null);

async function switchRoom(id){
  activeRoomId = id;
  // detach previous listener by reloading onValue usage (onValue doesn't return an unsub in this sdk, so we simply let it overwrite)
  commentsDiv.innerHTML = '';
  if(!id) {
    selectedRoomDisplay.textContent='‚Äî';
    activeRoomName.textContent='None';
    localStorage.removeItem('sigma_lastRoom');
    return;
  }
  localStorage.setItem('sigma_lastRoom', id);
  const roomSnap = await get(child(ref(db), `rooms/${id}`));
  const roomData = roomSnap.val();
  activeRoomName.textContent = roomData ? roomData.name : id;
  selectedRoomDisplay.textContent = roomData ? roomData.name : id;

  // presence: set under rooms/{id}/users/{userId}
  await set(ref(db, `rooms/${id}/users/${userId}`), { username: username || 'Anon', color: userColor, lastSeen: Date.now() });

  // Listen to comments
  const commentsRef = ref(db, `rooms/${id}/comments`);
  onValue(commentsRef, snap=>{
    const data = snap.val() || {};
    commentsDiv.innerHTML = '';
    Object.keys(data).forEach(key=>{
      const c = data[key];
      const div = document.createElement('div');
      div.className='comment';
      const timeText = c.time ? new Date(c.time).toLocaleString() : '';
      const top = document.createElement('div'); top.className='commentTop';
      const nameSpan = document.createElement('span'); nameSpan.className='username'; nameSpan.style.color = c.color || '#fff'; nameSpan.textContent = c.username || 'Anon';
      const metaSpan = document.createElement('span'); metaSpan.className='meta'; metaSpan.textContent = timeText;
      top.appendChild(nameSpan); top.appendChild(metaSpan);
      const textDiv = document.createElement('div'); textDiv.style.marginTop='6px'; textDiv.textContent = c.text;
      div.appendChild(top); div.appendChild(textDiv);

      // Delete (only own)
      if(c.userId === userId){
        const del = document.createElement('button');
        del.className='deleteBtn';
        del.textContent='Delete';
        del.onclick = ()=> { if(confirm('Delete this message?')) remove(ref(db, `rooms/${id}/comments/${key}`)); };
        div.appendChild(del);
      }

      // Reaction area
      const reactionBar = document.createElement('div');
      reactionBar.style.marginTop = '8px';
      reactionBar.style.display = 'flex';
      reactionBar.style.gap = '6px';
      reactionBar.style.alignItems = 'center';

      // show existing reactions counts
      if(c.reactions){
        Object.keys(c.reactions).forEach(emoji=>{
          const usersObj = c.reactions[emoji] || {};
          const count = Object.keys(usersObj).length;
          const btn = document.createElement('button');
          btn.style.background='transparent'; btn.style.border='none'; btn.style.color='#fff'; btn.style.cursor='pointer';
          btn.textContent = `${emoji} ${count}`;
          btn.onclick = async () => {
            const userReactionRef = ref(db, `rooms/${id}/comments/${key}/reactions/${emoji}/${userId}`);
            const s = await get(userReactionRef);
            if(s.exists()) { await remove(userReactionRef); } else { await set(userReactionRef, true); }
          };
          reactionBar.appendChild(btn);
        });
      }

      // custom emoji input
      const input = document.createElement('input');
      input.type='text'; input.className='emojiInput'; input.placeholder='‚ûï'; input.maxLength=2;
      input.onkeydown = async (e) => {
        if(e.key === 'Enter'){
          const emoji = input.value.trim();
          if(!emoji) return;
          await set(ref(db, `rooms/${id}/comments/${key}/reactions/${emoji}/${userId}`), true);
          input.value = '';
        }
      };
      reactionBar.appendChild(input);

      // show/hide reaction bar toggle
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'reactionsBtn';
      toggleBtn.textContent = 'üòä Reactions';
      toggleBtn.onclick = () => reactionBar.style.display = (reactionBar.style.display === 'none' ? 'flex' : 'none');

      div.appendChild(toggleBtn);
      div.appendChild(reactionBar);

      commentsDiv.appendChild(div);
    });
    commentsDiv.scrollTop = commentsDiv.scrollHeight;
  });

  // load banned list for display in ban overlay
  refreshBannedList();
}

// Send message
sendBtn.onclick = async () => {
  if(!activeRoomId) return alert('Pick a room first');
  const text = messageInput.value.trim();
  const name = localStorage.getItem('sigma_username') || usernameInput.value.trim();
  if(!name) return alert('Set your username first');
  if(!text) return;
  // check banned
  const bannedSnap = await get(child(ref(db), `rooms/${activeRoomId}/banned/${userId}`));
  if(bannedSnap.exists()) return alert('You are banned from this room.');
  await push(ref(db, `rooms/${activeRoomId}/comments`), {
    username: name,
    userId,
    text,
    color: userColor,
    time: Date.now()
  });
  messageInput.value = '';
};

// Username save/change
saveUsernameBtn.onclick = () => {
  const n = usernameInput.value.trim();
  if(!n) return alert('Type a username');
  username = n; localStorage.setItem('sigma_username', username);
  usernameInput.disabled = true;
  alert('Username saved');
};
changeUsernameBtn.onclick = () => { usernameInput.disabled = false; localStorage.removeItem('sigma_username'); };

// Overlays toggles
onlineBtn.onclick = ()=> { if(!activeRoomId) return alert('Pick a room first'); onlineOverlay.style.display='flex'; loadOnlinePlayers(); };
closeOnline.onclick = ()=> onlineOverlay.style.display='none';

adminBtn.onclick = async ()=> {
  if(!activeRoomId) return alert('Pick a room first');
  adminOverlay.style.display='flex';
  const rSnap = await get(child(ref(db), `rooms/${activeRoomId}`));
  const r = rSnap.val() || {};
  const createdBy = r.createdBy || null;
  adminInfo.innerHTML = `Room creator ID: <strong>${createdBy||'‚Äî'}</strong><br>Your ID: <strong>${userId}</strong>`;
  // show/hide claim button and clear button based on admin status
  if(createdBy && createdBy === userId) { claimRoomBtn.style.display='none'; clearMessagesBtn.style.display='inline-block'; }
  else { claimRoomBtn.style.display='inline-block'; clearMessagesBtn.style.display='none'; }
};
closeAdmin.onclick = ()=> adminOverlay.style.display='none';

banlandBtn.onclick = ()=> { if(!activeRoomId) return alert('Pick a room first'); banOverlay.style.display='flex'; refreshBannedList(); };
closeBan.onclick = ()=> banOverlay.style.display='none';

rulesBtn.onclick = ()=> rulesOverlay.style.display='flex';
closeRules.onclick = ()=> rulesOverlay.style.display='none';

// Admin actions
clearMessagesBtn.onclick = async ()=> {
  if(!confirm('Clear ALL messages in this room?')) return;
  await set(ref(db, `rooms/${activeRoomId}/comments`), null);
  alert('Messages cleared');
};

claimRoomBtn.onclick = async ()=> {
  if(!confirm('Claim this room as creator/admin? This will set you as room creator.')) return;
  await set(ref(db, `rooms/${activeRoomId}/createdBy`), userId);
  alert('You are now the room creator (admin)');
  const rSnap = await get(child(ref(db), `rooms/${activeRoomId}`));
  adminInfo.innerHTML = `Room creator ID: <strong>${rSnap.val().createdBy}</strong><br>Your ID: <strong>${userId}</strong>`;
  claimRoomBtn.style.display='none';
  clearMessagesBtn.style.display='inline-block';
};

// Ban/unban via Banland UI
banUserBtn.onclick = async ()=> {
  const target = banUserInput.value.trim();
  if(!target) return alert('Type user ID to ban');
  await set(ref(db, `rooms/${activeRoomId}/banned/${target}`), { by: userId, at: Date.now() });
  banUserInput.value='';
  refreshBannedList();
};
async function refreshBannedList(){
  if(!activeRoomId) return;
  const snap = await get(child(ref(db), `rooms/${activeRoomId}/banned`));
  const banned = snap.val() || {};
  bannedList.innerHTML = '';
  Object.keys(banned).forEach(uid=>{
    const row = document.createElement('div'); row.className='list-item';
    const left = document.createElement('div'); left.textContent = uid;
    const right = document.createElement('div');
    const un = document.createElement('button'); un.textContent='Unban'; un.onclick = async ()=> {
      if(confirm('Unban this user?')) { await remove(ref(db, `rooms/${activeRoomId}/banned/${uid}`)); refreshBannedList(); }
    };
    right.appendChild(un);
    row.appendChild(left); row.appendChild(right);
    bannedList.appendChild(row);
  });
}

// Load online players
async function loadOnlinePlayers(){
  if(!activeRoomId) return;
  const snap = await get(child(ref(db), `rooms/${activeRoomId}/users`));
  const users = snap.val() || {};
  onlineList.innerHTML = '';
  Object.keys(users).forEach(uid=>{
    const u = users[uid];
    const row = document.createElement('div'); row.className='list-item';
    row.innerHTML = `<div><span style="display:inline-block;width:28px;height:28px;background:${u.color||'#666'};border-radius:50%;text-align:center;line-height:28px;margin-right:8px">${u.username ? u.username[0].toUpperCase() : '?'}</span><strong>${u.username||'Anon'}</strong> <small style="color:rgba(255,255,255,0.6)">(${uid})</small></div>`;
    onlineList.appendChild(row);
  });
}

// Helper: escape
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

</script>
</body>
</html>

