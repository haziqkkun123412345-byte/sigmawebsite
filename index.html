<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SigmaChat v2</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --accent: #9c27b0; --glass: rgba(255,255,255,0.08); }
    body {
      margin:0; font-family: system-ui, Arial, sans-serif;
      background: linear-gradient(135deg,#6a0dad,#000); color:#fff;
      min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:20px;
    }
    header{width:100%;max-width:1000px;display:flex;justify-content:space-between;align-items:center}
    .card{background:var(--glass);padding:10px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.5)}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0;width:100%;max-width:1000px;align-items:center}
    select,input,button{padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.08);color:#fff}
    #main{width:100%;max-width:1000px;display:flex;gap:12px}
    #left{flex:1} #right{width:260px}
    #comments{height:420px;overflow:auto;padding:12px}
    .bubble{padding:10px 12px;border-radius:16px;margin:8px 0;max-width:75%;display:inline-block}
    .me{background:linear-gradient(90deg,#d0b3ff,#9c27b0);color:#000;border-bottom-right-radius:4px}
    .other{background:rgba(255,255,255,0.12)}
    .meta{font-size:12px;color:#ddd;margin-left:8px}
    .avatar{display:inline-block;width:30px;height:30px;border-radius:50%;text-align:center;line-height:30px;margin-right:8px;font-size:18px}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center}
    .modal{width:320px;background:var(--glass);padding:14px;border-radius:10px}
    .list-item{display:flex;align-items:center;justify-content:space-between;padding:6px 0}
    @media (max-width:720px){#main{flex-direction:column}#right{width:100%}}
  </style>
</head>
<body>

  <header>
    <h2>SigmaChat v2</h2>
    <div style="font-size:14px;color:#ddd">Firebase Realtime Chat</div>
  </header>

  <div class="controls">
    <div class="card">
      <label>Rooms</label>
      <select id="roomsSelect"><option value="">â€” Select room â€”</option></select>
      <input id="newRoomInput" placeholder="New room name" />
      <button id="createRoomBtn">Create</button>
    </div>

    <div class="card">
      <label>Name</label>
      <input id="usernameInput" placeholder="Your username" />
      <input id="emojiInput" placeholder="Emoji" style="width:80px" />
      <button id="saveUsernameBtn">Save</button>
    </div>

    <div class="card">
      <button id="themeBtn">ðŸŽ¨ Theme</button>
      <button id="onlineBtn">ðŸ‘¥ Online</button>
      <button id="banlandBtn">ðŸš« Banland</button>
    </div>
  </div>

  <div id="main">
    <div id="left">
      <div class="card">
        <input id="messageInput" style="width:75%" placeholder="Type message..." />
        <button id="sendBtn">Send</button>
      </div>
      <div id="comments" class="card">
        <div style="opacity:.7">No messages yet â€” select a room</div>
      </div>
    </div>
    <div id="right">
      <div class="card"><b>Room:</b> <span id="selectedRoom">â€”</span></div>
    </div>
  </div>

  <!-- Firebase + Chat Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove, get, child, onDisconnect } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDgORv7p_8He7kFKmFZ2oKJqSoOYeJoKKY",
      authDomain: "sigma-website-f2426.firebaseapp.com",
      databaseURL: "https://sigma-website-f2426-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "sigma-website-f2426",
      storageBucket: "sigma-website-f2426.appspot.com",
      messagingSenderId: "1030464935755",
      appId: "1:1030464935755:web:5784435e0cfe18ba30bace"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const roomsRef = ref(db, "rooms");
    const roomsSelect = document.getElementById("roomsSelect");
    const commentsDiv = document.getElementById("comments");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const usernameInput = document.getElementById("usernameInput");
    const emojiInput = document.getElementById("emojiInput");
    const saveUsernameBtn = document.getElementById("saveUsernameBtn");
    const newRoomInput = document.getElementById("newRoomInput");
    const createRoomBtn = document.getElementById("createRoomBtn");
    const selectedRoomDisplay = document.getElementById("selectedRoom");

    let activeRoomId = null;

    const USER_KEY = "sigma_user";
    let localUser = JSON.parse(localStorage.getItem(USER_KEY) || "{}");
    if (!localUser.userId) {
      localUser = {
        username: "",
        emoji: "ðŸ˜Ž",
        color: "#"+Math.floor(Math.random()*16777215).toString(16),
        userId: Math.random().toString(36).slice(2,10)
      };
      localStorage.setItem(USER_KEY, JSON.stringify(localUser));
    }

    usernameInput.value = localUser.username || "";
    emojiInput.value = localUser.emoji || "ðŸ˜Ž";

    // Load rooms
    onValue(roomsRef, (snap)=>{
      const val = snap.val() || {};
      roomsSelect.innerHTML = '<option value="">â€” Select room â€”</option>';
      for (const id in val) {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = val[id].name || id;
        roomsSelect.appendChild(opt);
      }
    });

    // Create room
    createRoomBtn.onclick = async ()=>{
      const name = newRoomInput.value.trim();
      if (!name) return alert("Enter a room name");
      await push(roomsRef, { name, createdBy: localUser.userId, createdAt: Date.now() });
      newRoomInput.value = "";
    };

    // Join room
    roomsSelect.onchange = async ()=>{
      const id = roomsSelect.value;
      if (!id) return;
      activeRoomId = id;
      selectedRoomDisplay.textContent = (await get(child(ref(db),`rooms/${id}/name`))).val();
      const userRef = ref(db, `rooms/${id}/users/${localUser.userId}`);
      await set(userRef, { username: localUser.username, emoji: localUser.emoji, color: localUser.color });
      onDisconnect(userRef).remove();
      listenComments();
    };

    // Save username
    saveUsernameBtn.onclick = ()=>{
      localUser.username = usernameInput.value.trim() || "User";
      localUser.emoji = emojiInput.value.trim() || "ðŸ™‚";
      localStorage.setItem(USER_KEY, JSON.stringify(localUser));
      alert("Saved!");
    };

    // Send message
    sendBtn.onclick = async ()=>{
      if (!activeRoomId) return alert("Select a room");
      const text = messageInput.value.trim();
      if (!text) return;
      await push(ref(db,`rooms/${activeRoomId}/comments`), {
        username: localUser.username,
        userId: localUser.userId,
        emoji: localUser.emoji,
        color: localUser.color,
        text,
        time: Date.now()
      });
      messageInput.value = "";
    };

    // Listen to messages
    function listenComments(){
      const cRef = ref(db, `rooms/${activeRoomId}/comments`);
      onValue(cRef, (snap)=>{
        const val = snap.val() || {};
        commentsDiv.innerHTML = "";
        Object.keys(val).forEach(cid=>{
          const c = val[cid];
          const div = document.createElement("div");
          div.className = "bubble " + (c.userId===localUser.userId?"me":"other");
          div.innerHTML = `<span class="avatar">${c.emoji}</span> <b style="color:${c.color}">${c.username}</b><br>${c.text}`;
          commentsDiv.appendChild(div);
        });
        commentsDiv.scrollTop = commentsDiv.scrollHeight;
      });
    }
  </script>
</body>
</html>
 
