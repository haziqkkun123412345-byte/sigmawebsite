<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>temu discord</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--accent:#9c27b0}
body{
  margin:0; font-family:Segoe UI,Arial,sans-serif;
  background: linear-gradient(135deg,#6a0dad,#000);
  color:white; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:18px;
}
h1{margin:6px 0 14px; text-shadow:0 0 8px rgba(0,0,0,.4)}
.topbar{display:flex;gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap}
.card{background:rgba(255,255,255,.06); padding:12px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.5)}
#roomsRow{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
select, input[type="text"], input[type="color"]{padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,.08); color:white}
button{background:var(--accent); color:white; padding:8px 10px; border:none; border-radius:8px; cursor:pointer; font-weight:600}
button:hover{opacity:.95}
#comments{width:100%; max-width:900px; margin-top:14px; background:rgba(255,255,255,.06); border-radius:10px; padding:12px; max-height:420px; overflow:auto; scroll-behavior: smooth;}
.comment{background:rgba(0,0,0,.35); padding:10px; border-radius:8px; margin-bottom:8px; position:relative; display:flex; flex-direction:column}
.commentTop{display:flex; align-items:center; gap:8px}
.username{font-weight:700}
.meta{font-size:12px; color:#ddd; margin-left:8px}
.deleteBtn{position:absolute; right:10px; top:10px; background:transparent; border:none; color:#ff7675; cursor:pointer}
.reactionsBtn{position:absolute; top:10px; right:110px; background:transparent; border:none; color:#fff; cursor:pointer}
.small{font-size:13px; color:#ddd}
.emojiInput{width:40px; padding:2px 6px; border-radius:6px; border:none; background:rgba(255,255,255,.1); color:#fff; text-align:center}
.overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:999}
.modal{width:92%; max-width:420px; background:rgba(255,255,255,0.06); padding:12px; border-radius:10px}
.list-item{display:flex; justify-content:space-between; align-items:center; padding:8px 6px; border-bottom:1px solid rgba(255,255,255,0.03)}
/* Prevent reaction bar from blocking input */
.comment .reactionBar {
  position: relative;
  z-index: 1;
  margin-top: 8px;
}
@media (max-width:520px){
  .topbar{flex-direction:column; align-items:stretch}
  .card{width:100%}
  #comments{max-height:300px}
}
</style>
</head>
<body>

<h1>üí¨ temu discord</h1>

<div class="topbar">
  <div class="card" id="roomCard">
    <div id="roomsRow">
      <label class="small" for="roomsSelect">Room:</label>
      <select id="roomsSelect"><option value="">‚Äî Select a room ‚Äî</option></select>
      <input id="newRoomInput" type="text" placeholder="New room name (e.g. Chat1)">
      <button id="createRoomBtn">Create room</button>
    </div>
    <div class="small" style="margin-top:8px">Active room: <span id="activeRoomName">None</span></div>
  </div>

  <div class="card" id="userCard">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <div class="small">Name:</div>
      <input id="usernameInput" type="text" placeholder="Your name">
      <button id="saveUsernameBtn">Save</button>
      <button id="changeUsernameBtn">Change</button>
    </div>
    <div class="small" style="margin-top:8px">You can change your name anytime. Saved locally.</div>
  </div>

  <div class="card" id="adminCard" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
    <button id="onlineBtn">üë• Online Players</button>
    <button id="adminBtn">‚öôÔ∏è Admin Panel</button>
    <button id="banlandBtn">üö´ Banland</button>
    <button id="rulesBtn">üìú Rules</button>
  </div>
</div>

<div class="card" style="width:100%; max-width:900px; margin-bottom:8px">
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
    <input id="messageInput" type="text" placeholder="Type a message..." style="flex:1">
    <button id="sendBtn">Send</button>
  </div>
  <div class="small" style="margin-top:8px">Selected room: <strong id="selectedRoomDisplay">‚Äî</strong></div>
</div>

<div id="comments" class="card"></div>

<!-- overlays omitted for brevity (keep your same overlays here) -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, child, get, set } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDgORv7p_8He7kFKmFZ2oKJqSoOYeJoKKY",
  authDomain: "sigma-website-f2426.firebaseapp.com",
  databaseURL: "https://sigma-website-f2426-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "sigma-website-f2426",
  storageBucket: "sigma-website-f2426.firebasestorage.app",
  messagingSenderId: "1030464935755",
  appId: "1:1030464935755:web:5784435e0cfe18ba30bace",
  measurementId: "G-1V1CJC9MHG"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const roomsSelect = document.getElementById('roomsSelect');
const createRoomBtn = document.getElementById('createRoomBtn');
const newRoomInput = document.getElementById('newRoomInput');
const activeRoomName = document.getElementById('activeRoomName');
const selectedRoomDisplay = document.getElementById('selectedRoomDisplay');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const commentsDiv = document.getElementById('comments');

let username = localStorage.getItem('sigma_username') || '';
let userId = localStorage.getItem('sigma_userId');
let userColor = localStorage.getItem('sigma_userColor');
let lastRoom = localStorage.getItem('sigma_lastRoom');
if (!userId) { userId = Math.random().toString(36).slice(2,12); localStorage.setItem('sigma_userId', userId); }
if (!userColor) { userColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'); localStorage.setItem('sigma_userColor', userColor); }

const roomsRef = ref(db, 'rooms');
let activeRoomId = null;

onValue(roomsRef, snap=>{
  const val = snap.val() || {};
  roomsSelect.innerHTML = '<option value="">‚Äî Select a room ‚Äî</option>';
  Object.keys(val).forEach(id=>{
    const o = document.createElement('option');
    o.value=id; o.textContent=val[id].name;
    roomsSelect.appendChild(o);
  });
  if(lastRoom && val[lastRoom]) { roomsSelect.value = lastRoom; switchRoom(lastRoom); }
});
createRoomBtn.onclick = async ()=>{
  const name = newRoomInput.value.trim();
  if(!name) return alert('Type a room name');
  const pushed = await push(roomsRef,{name,createdBy:userId,createdAt:Date.now()});
  newRoomInput.value=''; roomsSelect.value=pushed.key; switchRoom(pushed.key);
};
roomsSelect.onchange=()=>switchRoom(roomsSelect.value||null);

async function switchRoom(id){
  activeRoomId=id; commentsDiv.innerHTML='';
  if(!id){selectedRoomDisplay.textContent='‚Äî'; activeRoomName.textContent='None'; return;}
  const roomSnap=await get(child(ref(db),`rooms/${id}`));
  const roomData=roomSnap.val();
  activeRoomName.textContent=roomData?roomData.name:id;
  selectedRoomDisplay.textContent=roomData?roomData.name:id;

  const commentsRef = ref(db, `rooms/${id}/comments`);
  onValue(commentsRef, snap=>{
    const data=snap.val()||{};
    commentsDiv.innerHTML='';
    Object.keys(data).forEach(key=>{
      const c=data[key];
      const div=document.createElement('div'); div.className='comment';
      const top=document.createElement('div'); top.className='commentTop';
      const nameSpan=document.createElement('span'); nameSpan.className='username'; nameSpan.style.color=c.color||'#fff'; nameSpan.textContent=c.username||'Anon';
      const metaSpan=document.createElement('span'); metaSpan.className='meta'; metaSpan.textContent=new Date(c.time).toLocaleString();
      top.appendChild(nameSpan); top.appendChild(metaSpan);
      const textDiv=document.createElement('div'); textDiv.style.marginTop='6px'; textDiv.textContent=c.text;
      div.appendChild(top); div.appendChild(textDiv);

      if(c.userId===userId){
        const del=document.createElement('button');
        del.className='deleteBtn'; del.textContent='Delete';
        del.onclick=()=>{if(confirm('Delete this message?')) remove(ref(db,`rooms/${id}/comments/${key}`));};
        div.appendChild(del);
      }

      const reactionBar=document.createElement('div');
      reactionBar.className='reactionBar';
      reactionBar.style.display='none';
      reactionBar.style.gap='6px';
      reactionBar.style.alignItems='center';

      if(c.reactions){
        Object.keys(c.reactions).forEach(emoji=>{
          const usersObj=c.reactions[emoji]||{};
          const count=Object.keys(usersObj).length;
          const btn=document.createElement('button');
          btn.style.background='transparent';
          btn.style.border='none';
          btn.style.color='#fff';
          btn.style.cursor='pointer';
          btn.textContent=`${emoji} ${count}`;
          btn.onclick=async()=>{
            const userReactionRef=ref(db,`rooms/${id}/comments/${key}/reactions/${emoji}/${userId}`);
            const s=await get(userReactionRef);
            if(s.exists()) await remove(userReactionRef); else await set(userReactionRef,true);
          };
          reactionBar.appendChild(btn);
        });
      }

      const input=document.createElement('input');
      input.type='text'; input.className='emojiInput'; input.placeholder='‚ûï'; input.maxLength=2;
      input.onkeydown=async(e)=>{
        if(e.key==='Enter'){
          const emoji=input.value.trim();
          if(!emoji)return;
          await set(ref(db,`rooms/${id}/comments/${key}/reactions/${emoji}/${userId}`),true);
          input.value='';
        }
      };
      reactionBar.appendChild(input);

      const toggleBtn=document.createElement('button');
      toggleBtn.className='reactionsBtn';
      toggleBtn.textContent='üòä Reactions';
      toggleBtn.onclick=()=>reactionBar.style.display=(reactionBar.style.display==='none'?'flex':'none');

      div.appendChild(toggleBtn);
      div.appendChild(reactionBar);
      commentsDiv.appendChild(div);
    });
    commentsDiv.scrollTop=commentsDiv.scrollHeight;
  });
}

sendBtn.onclick=async()=>{
  if(!activeRoomId)return alert('Pick a room first');
  const text=messageInput.value.trim();
  if(!text)return;
  await push(ref(db,`rooms/${activeRoomId}/comments`),{
    username:localStorage.getItem('sigma_username')||'Anon',
    userId,text,color:userColor,time:Date.now()
  });
  messageInput.value='';
};
</script>
</body>
</html>
